<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truncar Silencio PRO v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: #020617; color: white; overflow-x: hidden; }
       .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.3); }
       .gradient-bg { background: radial-gradient(circle at top right, rgba(139, 92, 246, 0.15), transparent), radial-gradient(circle at bottom left, rgba(236, 72, 153, 0.15), transparent); }
       .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
       .progress-glow { box-shadow: 0 0 15px rgba(168, 85, 247, 0.5); }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [isProc, setIsProc] = useState(false);
            const [prog, setProg] = useState(0);
            const = useState(null); // Guardamos los chunks en vez de URL directa
            const = useState(false);
            const [fileName, setFileName] = useState("audio_optimizado");
            const audioCtx = useRef(null);

            const processAudio = async () => {
                if (!file) return;
                setIsProc(true);
                setProg(5);
                try {
                    if (!audioCtx.current) audioCtx.current = new (window.AudioContext |

| window.webkitAudioContext)();
                    
                    // Decodificaci√≥n con gesti√≥n de memoria
                    const arrayBuffer = await file.arrayBuffer();
                    const buf = await audioCtx.current.decodeAudioData(arrayBuffer);
                    const data = buf.getChannelData(0);
                    const rate = buf.sampleRate;
                    const limit = Math.pow(10, -30 / 20); // -30dB
                    const minSilence = Math.floor(0.6 * rate);
                    
                    let output = new Float32Array(data.length);
                    let outIdx = 0;
                    
                    // Algoritmo de truncado
                    for (let i = 0; i < data.length; ) {
                        if (Math.abs(data[i]) < limit) {
                            let s = i;
                            while (i < data.length && Math.abs(data[i]) < limit) i++;
                            if ((i - s) >= minSilence) {
                                const m = Math.floor(0.1 * rate); // Deja 0.1s de aire
                                for (let j = 0; j < m; j++) output[outIdx++] = 0;
                            } else {
                                for (let j = s; j < i; j++) output[outIdx++] = data[j];
                            }
                        } else {
                            output[outIdx++] = data[i]; i++;
                        }
                        if (i % 1000000 === 0) {
                            setProg(Math.floor(10 + (i / data.length) * 30));
                            await new Promise(r => setTimeout(r, 0));
                        }
                    }
                    
                    // Codificaci√≥n MP3 por chunks para evitar bloqueos
                    const enc = new lamejs.Mp3Encoder(1, rate, 128);
                    const chunks =;
                    for (let i = 0; i < outIdx; i += 1152) {
                        const chunk = output.subarray(i, i + 1152);
                        const i16 = new Int16Array(chunk.length);
                        for (let j = 0; j < chunk.length; j++) {
                            const v = Math.max(-1, Math.min(1, chunk[j]));
                            i16[j] = v < 0? v * 0x8000 : v * 0x7FFF;
                        }
                        const b = enc.encodeBuffer(i16);
                        if (b.length > 0) chunks.push(new Uint8Array(b));
                        if (i % 400000 === 0) {
                            setProg(Math.floor(40 + (i / outIdx) * 55));
                            await new Promise(r => setTimeout(r, 0)); 
                        }
                    }
                    chunks.push(new Uint8Array(enc.flush()));
                    setAudioData(chunks); // Guardamos los datos procesados
                    setProg(100);
                    setTimeout(() => setShowSaveModal(true), 500); // Lanzar modal de guardado
                } catch (e) { 
                    alert("Error de memoria. Intenta con un archivo m√°s corto."); 
                }
                setIsProc(false);
            };

            const triggerDownload = () => {
                if (!audioData) return;
                const blob = new Blob(audioData, { type: 'audio/mp3' });
                const finalName = fileName.endsWith('.mp3')? fileName : `${fileName}.mp3`;

                // M√âTODO COMPATIBLE CON APK/WEBVIEW
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64data = e.target.result;
                    const link = document.createElement('a');
                    link.href = base64data;
                    link.download = finalName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setShowSaveModal(false);
                };
                reader.readAsDataURL(blob); // Esto convierte el blob en una data-URL segura para WebView
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="w-full max-w-lg glass-card p-8 rounded-[2.5rem] shadow-2xl relative z-10 animate-float">
                        <header className="text-center mb-8">
                            <div className="inline-block p-4 bg-violet-600 rounded-3xl mb-4 shadow-lg shadow-violet-500/20">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                            </div>
                            <h1 className="text-3xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-violet-400 to-pink-400 uppercase">
                                Truncar Silencio PRO
                            </h1>
                        </header>

                        {!audioData? (
                            <div className="space-y-6">
                                <div className="border-2 border-dashed border-violet-500/30 rounded-3xl p-12 text-center bg-slate-900/40 hover:bg-slate-900/60 transition-all">
                                    <input type="file" onChange={e => {setFile(e.target.files); setAudioData(null);}} className="hidden" id="aud" accept="audio/*" />
                                    <label htmlFor="aud" className="cursor-pointer group">
                                        <div className="text-5xl mb-4 group-hover:scale-110 transition-transform">üìÅ</div>
                                        <div className="text-violet-200 font-bold tracking-wide">
                                            {file? file.name : "Subir archivo de audio"}
                                        </div>
                                        <p className="text-xs text-slate-400 mt-2">Formatos compatibles: MP3, WAV, M4A</p>
                                    </label>
                                </div>

                                {isProc && (
                                    <div className="animate-pulse">
                                        <div className="flex justify-between text-xs text-violet-300 mb-2 font-bold uppercase tracking-widest">
                                            <span>Optimizando...</span>
                                            <span>{prog}%</span>
                                        </div>
                                        <div className="h-3 bg-slate-800 rounded-full overflow-hidden">
                                            <div className="h-full bg-gradient-to-r from-violet-500 to-pink-500 progress-glow transition-all duration-300" style={{width: `${prog}%`}}></div>
                                        </div>
                                    </div>
                                )}

                                <button 
                                    onClick={processAudio} 
                                    disabled={!file |

| isProc} 
                                    className="w-full py-5 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl font-bold text-lg hover:shadow-2xl hover:shadow-violet-500/40 disabled:opacity-30 transition-all uppercase tracking-widest"
                                >
                                    {isProc? "Trabajando..." : "‚ö° Procesar Audio"}
                                </button>
                            </div>
                        ) : (
                            <div className="text-center py-6">
                                <div className="text-6xl mb-4">‚ú®</div>
                                <h2 className="text-xl font-bold text-violet-200 mb-6 uppercase">¬°Audio procesado con √©xito!</h2>
                                <button 
                                    onClick={() => setShowSaveModal(true)} 
                                    className="w-full py-5 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-bold text-lg transition-all mb-4"
                                >
                                    ‚¨áÔ∏è Guardar archivo
                                </button>
                                <button 
                                    onClick={() => {setAudioData(null); setFile(null); setProg(0);}} 
                                    className="text-slate-400 hover:text-white text-sm font-semibold uppercase tracking-widest"
                                >
                                    üîÑ Procesar otro audio
                                </button>
                            </div>
                        )}
                    </div>

                    {/* MODAL GUARDAR COMO */}
                    {showSaveModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
                            <div className="w-full max-w-sm glass-card p-8 rounded-[2rem] border-violet-500/50 shadow-2xl scale-110 transition-transform">
                                <h3 className="text-xl font-extrabold mb-6 text-center text-violet-300 uppercase tracking-tight">Guardar Como</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500 tracking-[0.2em] ml-2">Nombre del archivo</label>
                                        <input 
                                            autoFocus
                                            type="text" 
                                            value={fileName} 
                                            onChange={e => setFileName(e.target.value)}
                                            className="w-full bg-slate-800 border-2 border-violet-500/20 rounded-xl px-4 py-4 text-white focus:border-violet-500 outline-none transition-all"
                                            placeholder="Escribe el nombre..."
                                        />
                                    </div>
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={() => setShowSaveModal(false)}
                                            className="flex-1 py-4 text-slate-400 font-bold hover:bg-slate-800 rounded-xl transition-all uppercase text-xs tracking-widest"
                                        >
                                            Cancelar
                                        </button>
                                        <button 
                                            onClick={triggerDownload}
                                            className="flex-1 py-4 bg-violet-600 hover:bg-violet-500 text-white font-bold rounded-xl transition-all uppercase text-xs tracking-widest shadow-lg shadow-violet-500/20"
                                        >
                                            Guardar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="mt-12 text-center opacity-30 text-[10px] font-bold tracking-[0.3em] uppercase">
                        ¬© 2025 Yean Carlos Godoy Gonz√°lez ‚Ä¢ v2.0
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

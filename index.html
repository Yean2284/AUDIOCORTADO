<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truncar Silencio PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .card-pro { background: #1e293b; border: 1px solid #334155; border-radius: 2rem; }
        .gradient-btn { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }
        .progress-fill { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: linear-gradient(90deg, #a855f7, #ec4899); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [isProc, setIsProc] = useState(false);
            const [prog, setProg] = useState(0);
            const [downloadUrl, setDownloadUrl] = useState(null);
            const [status, setStatus] = useState("");

            const processAudio = async () => {
                if (!file) return;
                setIsProc(true);
                setProg(5);
                setStatus("Leyendo archivo...");

                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const arrayBuffer = await file.arrayBuffer();
                    setStatus("Decodificando...");
                    const audioBuffer = await audioCtx.current ? null : await audioCtx.decodeAudioData(arrayBuffer);
                    
                    const data = audioBuffer.getChannelData(0);
                    const sampleRate = audioBuffer.sampleRate;
                    const threshold = 0.02; // Umbral de silencio
                    const minSilenceLen = Math.floor(sampleRate * 0.6); // 0.6 segs
                    
                    setStatus("Eliminando silencios...");
                    let chunks = [];
                    let lastIdx = 0;

                    for (let i = 0; i < data.length; i++) {
                        if (Math.abs(data[i]) < threshold) {
                            let start = i;
                            while (i < data.length && Math.abs(data[i]) < threshold) i++;
                            if ((i - start) > minSilenceLen) {
                                chunks.push(data.subarray(lastIdx, start + Math.floor(sampleRate * 0.1)));
                                lastIdx = i;
                            }
                        }
                        if (i % 500000 === 0) setProg(Math.floor((i / data.length) * 40) + 10);
                    }
                    chunks.push(data.subarray(lastIdx));

                    setStatus("Codificando MP3...");
                    const encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
                    const mp3Data = [];
                    
                    for (let segment of chunks) {
                        for (let i = 0; i < segment.length; i += 1152) {
                            const chunk = segment.subarray(i, i + 1152);
                            const i16 = new Int16Array(chunk.length);
                            for (let j = 0; j < chunk.length; j++) {
                                i16[j] = chunk[j] < 0 ? chunk[j] * 0x8000 : chunk[j] * 0x7FFF;
                            }
                            const mp3buf = encoder.encodeBuffer(i16);
                            if (mp3buf.length > 0) mp3Data.push(new Uint8Array(mp3buf));
                        }
                        setProg(prev => Math.min(95, prev + 2));
                    }
                    mp3Data.push(new Uint8Array(encoder.flush()));

                    const blob = new Blob(mp3Data, { type: 'audio/mp3' });
                    setDownloadUrl(URL.createObjectURL(blob));
                    setStatus("¬°Listo!");
                    setProg(100);
                } catch (err) {
                    alert("Error de memoria. Intenta con un audio m√°s corto.");
                    console.error(err);
                }
                setIsProc(false);
            };

            const handleDownload = () => {
                const a = document.createElement("a");
                a.href = downloadUrl;
                a.download = "audio_optimizado.mp3";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            return (
                <div className="min-h-screen p-6 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md card-pro p-8 shadow-2xl">
                        <h1 className="text-2xl font-black text-center mb-2 text-purple-400">TRUNCAR SILENCIO PRO</h1>
                        <p className="text-center text-xs text-slate-400 mb-8 uppercase tracking-widest font-bold">Edici√≥n para APK 2025</p>

                        {!downloadUrl ? (
                            <div className="space-y-6">
                                <div className="border-2 border-dashed border-slate-700 rounded-2xl p-8 text-center bg-slate-800/50">
                                    <input type="file" id="f" accept="audio/*" className="hidden" onChange={e => setFile(e.target.files[0])} />
                                    <label htmlFor="f" className="cursor-pointer block">
                                        <div className="text-4xl mb-3">{file ? "‚úÖ" : "üéµ"}</div>
                                        <div className="text-sm font-bold truncate">{file ? file.name : "Toca para subir audio"}</div>
                                    </label>
                                </div>

                                {isProc && (
                                    <div className="space-y-2">
                                        <div className="flex justify-between text-[10px] font-bold uppercase">
                                            <span>{status}</span>
                                            <span>{prog}%</span>
                                        </div>
                                        <div className="h-2 w-full bg-slate-700 rounded-full overflow-hidden">
                                            <div className="h-full progress-fill" style={{width: `${prog}%`}}></div>
                                        </div>
                                    </div>
                                )}

                                <button 
                                    onClick={processAudio}
                                    disabled={!file || isProc}
                                    className="w-full py-4 rounded-xl font-bold gradient-btn shadow-lg disabled:opacity-50 active:scale-95 transition-transform"
                                >
                                    {isProc ? "PROCESANDO..." : "üöÄ PROCESAR AHORA"}
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-4 text-center">
                                <div className="p-6 bg-green-500/10 border border-green-500/20 rounded-2xl">
                                    <p className="text-green-400 font-bold mb-1">¬°Procesamiento Exitoso!</p>
                                    <p className="text-[10px] text-slate-400">El audio est√° listo para descargar</p>
                                </div>
                                <button onClick={handleDownload} className="w-full py-4 rounded-xl font-bold bg-green-600 shadow-lg active:scale-95 transition-transform">
                                    ‚¨áÔ∏è DESCARGAR MP3
                                </button>
                                <button onClick={() => {setDownloadUrl(null); setFile(null); setProg(0);}} className="text-xs text-slate-500 font-bold uppercase tracking-tighter">
                                    Procesar otro archivo
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="mt-8 text-center opacity-50">
                        <p className="text-[10px] font-bold uppercase tracking-widest">Desarrollado por</p>
                        <p className="text-sm font-black text-purple-400">YEAN CARLOS GODOY</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
